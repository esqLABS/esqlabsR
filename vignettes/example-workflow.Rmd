---
title: "Running simulations"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Example workflow}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
knitr::opts_knit$set(
  root.dir = "../tests/data/TestProject/Code/"
)
```

```{r, echo = FALSE, results = "hide", message = F}
library(esqlabsR)
projectConfiguration <- createDefaultProjectConfiguration()
dataSheets <- "Laskin 1982.Group A"
observedData <- loadObservedData(projectConfiguration = projectConfiguration, sheets = dataSheets)
```

### Workflow 

Within the `esqlabsR` framework, the simulations are run by defining and executing multiple *scenarios*. To define a scenario, create an Excel file located in `projectConfiguration$scenarioDefinitionFile`. This file must list the scenario name, involved individuals, application protocols, simulation time, PKML model and model parameters. 

The package includes [an example scenario](https://github.com/esqLABS/esqlabsR/blob/HEAD/tests/data/TestProject/Parameters/Scenarios.xlsx) that models the administration of a single dose of 250 mg aciclovir intravenously to an individual with a 90 mL/min estimated glomerular filtration rate. To define this scenario, the example configuration includes several Excel configuration files:

* the `ProjectConfiguration.xlsx` stores paths to four configuration files: `Parameters/IndividualPhysiology.xlsx`, `Parameters/ApplicationParameters.xlsx`, `Parameters/Scenarios.xlsx` and `Parameters/IndividualParameters.xlsx`
* the `IndividualPhysiology.xlsx` file defines an individual called `Indiv1`: an aged 30, 73 kg and 176 cm Caucasian human male.
* the `ApplicationParameters.xlsx` defines a protocol called `Aciclovir_iv_250mg`: a single dose of 250 mg delivered to the `Applications|IV 250mg 10min|Application_1|ProtocolSchemaItem` container.
* the `Scenarios.xlsx` defines a scenario called `TestScenario`, using `Indiv1` as an individual and `Aciclovir_iv_250mg` as the application protocol. The model file `Aciclovir.pkml` is also referenced and is expected to exist in the `projectConfiguration$modelFolder` folder. 
* the `IndividualParameters.xlsx` file redefines the GFR to be 90 mL/min

Scenarios are then executed by creating a `ScenarioConfiguration` object and calling a `runScenarios()` function with a specific scenario name (`TestScenario` in this case):

```{r runScenarios}
scenarioConfiguration <- ScenarioConfiguration$new(projectConfiguration)
OutputPaths <- enum(list(
  Aciclovir_PVB = "Organism|PeripheralVenousBlood|Aciclovir|Plasma (Peripheral Venous Blood)"
))
simulatedScenarios <- runScenarios(
  scenarioNames = c("TestScenario"),
  scenarioConfiguration = scenarioConfiguration,
  customParams = NULL, saveSimulationsToPKML = FALSE
)
```

The `runScenarios()` function relies on an `OutputPaths` variable being defined in the current environment. The variable is expected to contain path(s) to outputs generated by the model. In our case this is the simulated concentration of Aciclovir in the peripheral venous blood plasma.

The `runScenarios()` function returns a named list of lists with `Simulation` objects, `SimulationResults` objects, and vectors of output values.

```{r simulatedScenarios}
print(simulatedScenarios$TestScenario$results)
```

```{r outputValues}
print(head(simulatedScenarios$TestScenario$outputValues$data))
```

### Troubleshooting 

* The `runScenarios()` function will fail if the `OutputPaths` variable is missing in the current environment. Make sure to have this variable set up immediately before calling the `runScenarios()` function.

More detailed information on function signatures can be found in:

* `esqlabsR` documentation on:
    * [ProjectConfiguration class](https://esqlabs.github.io/esqlabsR/reference/ProjectConfiguration.html)
    * [ScenarioConfiguration class](https://esqlabs.github.io/esqlabsR/reference/ScenarioConfiguration.html)
    * [readScenarioConfigurationFromExcel()](https://esqlabs.github.io/esqlabsR/reference/readScenarioConfigurationFromExcel.html)
    * [runScenarios()](https://esqlabs.github.io/esqlabsR/reference/runScenarios.html)
    
* `ospsuite` documentation on:
    * [Simulation class](https://www.open-systems-pharmacology.org/OSPSuite-R/reference/Simulation.html)
    * [SimulationResults class](https://www.open-systems-pharmacology.org/OSPSuite-R/reference/SimulationResults.html)
