---
title: "Visualization and reporting"
output: rmarkdown::html_vignette
#output: pdf_document
vignette: >
  %\VignetteIndexEntry{Visualization and reporting}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
knitr::opts_knit$set(
  root.dir = "../tests/data/TestProject/Code/"
)
```

```{r, echo = FALSE, results = "hide", message = FALSE}
library(esqlabsR)
projectConfiguration <- createDefaultProjectConfiguration()
dataSheets <- "Laskin 1982.Group A"
observedData <- loadObservedData(projectConfiguration = projectConfiguration, sheets = dataSheets)
scenarioConfiguration <- ScenarioConfiguration$new(projectConfiguration)
OutputPaths <- enum(list(
  Aciclovir_PVB = "Organism|PeripheralVenousBlood|Aciclovir|Plasma (Peripheral Venous Blood)"
))
simulatedScenarios <- runScenarios(
  scenarioNames = c("TestScenario"),
  scenarioConfiguration = scenarioConfiguration,
  customParams = NULL, saveSimulationsToPKML = FALSE
)
```

### Workflow

Plotting the simulation results is an important part of model diagnostics and quality control. Simulated modeling scenarios can be passed to plotting functions from the `{ospsuite}` package to create uniformly-looking plots.

`DataCombined` is a class used to store matching observed and simulated data. Initialize a new class instance and populate it with data with the following code:

```{r datacombined}
dataCombined <- DataCombined$new()
dataCombined$addDataSets(observedData, names = "Observed", groups = "Aciclovir")
dataCombined$addSimulationResults(simulatedScenarios$TestScenario$results, names = "Simulated", groups = "Aciclovir")
dataCombined$toDataFrame()
```

The simulation results are stored in a list returned by the `runScenarios()` function. Plotting and visualization is performed by storing these results along with matching observed data in a `DataCombined` object and passing it to plotting functions. Observed data in the form of `Data Set` objects is added to a `DataCombined` object via the `addDataSets` method, simulated data can be added by using `addSimulationResults`. Observed and simulated data can be linked by setting the  `groups` argument in both methods. Data of the same group will then be plotted together when calling plotting functions on the `DataCombined` object.

Plotting functions in the `{ospsuite}` package are wrappers around `{tlf}` plotting functions that provide default plot configuration options. All of them accept instances of `DataCombined` class as the data source. 

Time profile plots visualize the pharmacokinetics of the drug in question and help assess if the observed data (represented by points and error bars) match the simulated data (represented by lines).


```{r plot-time-profile, fig.width=7, fig.height=4}
plotIndividualTimeProfile(dataCombined)
```

Observed versus simulated plots show if simulated time points and observed time points follow a linear trend.

```{r plot-obs-vs-pred, fig.width=7, fig.height=4}
plotObservedVsSimulated(dataCombined)
```

Residual plots show if there is a systematic bias in how the simulation represents values either in high-concentration or low-concentration regions, or, alternatively, in early or late time periods.

```{r residuals-vs-simulated, fig.width=7, fig.height=4}
plotResidualsVsSimulated(dataCombined)
```

```{r residuals-vs-time, fig.width=7, fig.height=4}
plotResidualsVsTime(dataCombined)
```

The plots returned by plotting functions are `ggplot` objects. They can be modified further and saved to files with `{ggplot2}` functions:

```{r save-plots}
plotObject <- plotIndividualTimeProfile(dataCombined)
ggplot2::ggsave(filename = "../Results/aciclovir_time_profile.png", plotObject, width = 8, height = 4)
```

### Troubleshooting

* At any time, you can check the groups assigned to the datasets in the `DataCombined` object by examining the output of `dataCombined$toDataFrame()`.

More detailed information on function signatures can be found in:

* `ospsuite` documentation on:
    * [Simulation class](https://www.open-systems-pharmacology.org/OSPSuite-R/reference/Simulation.html)
    * [SimulationResults class](https://www.open-systems-pharmacology.org/OSPSuite-R/reference/SimulationResults.html)
    * [DataCombined class](https://www.open-systems-pharmacology.org/OSPSuite-R/reference/DataCombined.html)
    * [plotIndividualTimeProfile()](https://www.open-systems-pharmacology.org/OSPSuite-R/reference/plotIndividualTimeProfile.html)
    * [plotObservedVsSimulated()](https://www.open-systems-pharmacology.org/OSPSuite-R/reference/plotObservedVsSimulated.html)
    * [plotResidualsVsSimulated()](https://www.open-systems-pharmacology.org/OSPSuite-R/reference/plotResidualsVsSimulated.html)
    * [plotResidualsVsTime()](https://www.open-systems-pharmacology.org/OSPSuite-R/reference/plotResidualsVsTime.html)
