---
title: "Introduction to esqlabsR"
output: 
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{Introduction to esqlabsR}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  dpi = 300
)
library(esqlabsR)
require(readxl)
```


## Introduction


We designed esqlabsR to make life easier for OSPS users. To achieve this, we
had to make things simpler:

- esqlabsR uses a predefined project structure to make sure its stays organized,
- esqlabsR uses excel files as a convenient way to inputs parameters,
- esqlabsR ...


## Project Initialisation

The major way `esqlabsR` facilitate modeling and simulation with OSPS is the 
adoption of a project structure based on Excel files. 
These templates are where all the parameters for running simulations, 
compute results and generating plots are defined. They are organized in 
different folders and their structure must not be altered.

The expected simulation project's folder structure is the following:

```sh
simulation_project/
├── ProjectConfiguration.xlsx
├── Data
├── Models
├── Parameters
└── Results
```

A project can me initialized with `init_project`.

```{r, eval=FALSE}
library(esqlabsR)

init_project(type = "example") 
# or simply init_project() to create an empty folder structure and excel templates.
```
Each one of these folders contains a series of `.xlsx` files with specific 
purpose. But the cornerstone of this setup is the `ProjectConfiguration.xlsx`.

### `ProjectConfiguration.xlsx`
This file defines *where* all the necessary files are stored in the project 
folder. All the path specified in the `Value` column should be *relative* to the
`ProjectConfiguration.xlsx` location.

The `ProjectConfiguration.xlsx` file will be used by `esqlabsR` to generate a
`ProjectConfiguration` object which is the central piece of a project.

```{r, eval=FALSE}
my_project_configuration <- createDefaultProjectConfiguration(path = "path/to/ProjectConfiguration.xlsx")

```
```
ProjectConfiguration: 
Relative path from working directory: C:/[path]/TestProject
Project Configuration File: Code/ProjectConfiguration.xlsx 
Model folder: Models/Simulations 
Parameters folder: Parameters 
Parameters file name: Parameters/ModelParameters.xlsx 
Individual parameters file name: Parameters/Individuals.xlsx 
Population parameters file name: Parameters/PopulationParameters.xlsx 
Scenario definitions file name: Parameters/Scenarios.xlsx 
Scenario applications definitions file name: Parameters/ApplicationParameters.xlsx 
Plot definitions file name: Parameters/Plots.xlsx 
Experimental data folder: Data 
Experimental data file: Data/TestProject_TimeValuesData.xlsx 
Data importer configuration: Data/esqlabs_dataImporter_configuration.xml 
Compound Properties File: Data/Compound Properties.xlsx 
Output folder: Results 
```

Notice that the `ProjectConfiguration` links to the other and files that 
constitute the project.

For more information about esqlabsR's project structure, read `vignettes("esqlabsR-project-structure")`.

## Design Simulations

Now that our project is ready, the next step is to run simulations. In esqlabsR,
simulation are run by defining and executing multiple **scenarios.**

A scenario is defined by:  

- The model to use,
- The parameters of the model,
- The application protocol,
- The simulation Time,
- [optional] The physiology of the individual or population.

To modify, add or delete a scenario, we edit the `$scenarioDefinitionFile` of the 
`ProjectConfiguration` object. Each row of this file is a scenario. Each Column is a parameter that will be 
used to define the scenarios.

Here are the main parameters that can be set for a scenario:

- `ModelFile` is the name of the `.pkml` file that can be found in the `Models/` directory.
- `ModelParameterSheets` is the name of the *sheet* in `Parameters/ModelParameters.xlsx` that contains the parameters to apply to the model,
- `PopulationId`: the id of the *population* to simulate. The id and settings for populations are defined in `Parameters/PopulationParameters.xlsx`,
- `ApplicationProtocol` is the name of the *sheet* in `Parameters/ApplicationParameters.xlsx` that specify the simulated drug administration protocol,
- `SimulationTime` and `SimulationTimeUnit` define the time range to simulate, it should be three numbers for start, end, resolution
- `Individuald`: the id of the individual to simulate. The id and settings for individuals are defined in `Parameters/Individuals.xlsx`,

Notice that the `Scenarios.xslx` file is mainly constituted of "link" to other excel templates. For example, if we want to change the characteristic of the individual we run the simulation on, we can either edit its properties directly in the `Individuals.xlsx` file or  add a new row with a different `IndividualId` and change to this new value in the `Scenarios.xslx` file.

For more information on all the scenario parameters that can be setup, read `vignette('esqlabsR-workflow)`.


Once all the scenario parameters are all setup in th excel files, we can import 
them using `createScenarios` and `readScenarioConfigurationFromExcel`:

```{r, echo=FALSE, warning=FALSE, message = FALSE}
my_project_configuration <- createDefaultProjectConfiguration(path = example_ProjectConfiguration())
```

```{r}
my_scenarios <-  createScenarios(
  readScenarioConfigurationFromExcel( # Read scenarios from excel file
    scenarioNames = "TestScenario", # Import the scenario defined as "TestScenario" 
    # in the excel file
    projectConfiguration = my_project_configuration
  )
)
```

```{r}
my_scenarios$TestScenario$scenarioConfiguration
```


## Run Simulations



```{r}
my_simulation <- runScenarios(
  scenarios = my_scenarios
)
```


## Plot results
