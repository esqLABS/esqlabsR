<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="esqlabsR">
<title>Standard workflow • esqlabsR</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Standard workflow">
<meta property="og:description" content="esqlabsR">
<meta property="og:image" content="https://esqlabs.github.io/esqlabsR/logo.png">
<meta name="robots" content="noindex">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">esqlabsR</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">5.0.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/introduction-esqlabsr.html">Introduction to esqlabsR</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Running simulations</h6>
    <a class="dropdown-item" href="../articles/standard-workflow.html">Standard workflow</a>
    <a class="dropdown-item" href="../articles/sensitivity-analysis.html">Sensitivity analysis</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Processing data</h6>
    <a class="dropdown-item" href="../articles/data-handling.html">Data handling</a>
    <a class="dropdown-item" href="../articles/visualization-and-reporting.html">Visualization and reporting</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Miscellaneous</h6>
    <a class="dropdown-item" href="../articles/shiny-apps.html">Using the esqlabsR Shiny apps</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/esqLABS/esqlabsR/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Standard workflow</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/esqLABS/esqlabsR/blob/HEAD/vignettes/standard-workflow.Rmd" class="external-link"><code>vignettes/standard-workflow.Rmd</code></a></small>
      <div class="d-none name"><code>standard-workflow.Rmd</code></div>
    </div>

    
    
<div class="section level3">
<h3 id="simulation-workflow">Simulation workflow<a class="anchor" aria-label="anchor" href="#simulation-workflow"></a>
</h3>
<p>Within the <code>esqlabsR</code> framework, the simulations are run
by defining and executing multiple <em>scenarios</em>. A scenario is
defined by the simulation file containing the model structure,
parametrization of the model, application protocol, and (optionally) the
physiology of the simulated individual or population. To simplify
scenarios set up, all these information are stored in excel files with
defined structure.</p>
<p>The package includes <a href="https://github.com/esqLABS/esqlabsR/blob/HEAD/tests/data/TestProject/Parameters/Scenarios.xlsx" class="external-link">an
example scenario</a> that models the administration of a single dose of
250 mg aciclovir intravenously to an individual with a 90 ml/min
estimated glomerular filtration rate.</p>
<p>The step wise approach of setting up a new simulation scenario is
shown in Figure 1, detailed description of the excel files structures
and <code>R</code> code are given in the <a href="#files-structure">Configuration files structure</a> section.</p>
<div class="figure">
<img src="Figures/ScenarioWorkflow.png" alt=""><p class="caption">Figure 1: Workflow of scenario set up</p>
</div>
<div class="section level4">
<h4 id="project-configuration">Project configuration<a class="anchor" aria-label="anchor" href="#project-configuration"></a>
</h4>
<p>Information about location of scenario definition files, simulation
files, output folders etc. is stored in excel file
<code>ProjectConfiguration.xlsx</code> located in the folder
<code>Code</code>. Usually it is not required to edit the contents of
this file.</p>
<p>The first step in the workflow is to create a
<code>ProjectConfiguration</code> from this file that will be used by
the scripts to know where to find the required data (for all following
examples, we assume that the current working directory is the
<code>Code</code> folder):</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">projectConfiguration</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/createDefaultProjectConfiguration.html">createDefaultProjectConfiguration</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">projectConfiguration</span><span class="op">)</span></span>
<span><span class="co">#&gt; ProjectConfiguration: </span></span>
<span><span class="co">#&gt;    Model folder: ../Models/Simulations </span></span>
<span><span class="co">#&gt;    Parameters folder: ../Parameters </span></span>
<span><span class="co">#&gt;    Parameters file name: ModelParameters.xlsx </span></span>
<span><span class="co">#&gt;    Individual parameters file name: Individuals.xlsx </span></span>
<span><span class="co">#&gt;    Population parameters file name: PopulationParameters.xlsx </span></span>
<span><span class="co">#&gt;    Scenario definitions file name: Scenarios.xlsx </span></span>
<span><span class="co">#&gt;    Scenario applications definitions file name: ApplicationParameters.xlsx </span></span>
<span><span class="co">#&gt;    Plot definitions file name: Plots.xlsx </span></span>
<span><span class="co">#&gt;    Experimental data folder: ../Data </span></span>
<span><span class="co">#&gt;    Experimental data file: TestProject_TimeValuesData.xlsx </span></span>
<span><span class="co">#&gt;    Data importer configuration: esqlabs_dataImporter_configuration.xml </span></span>
<span><span class="co">#&gt;    Output folder: ../Results</span></span></code></pre></div>
<p>If required, you can change the location of one of the files or
folders:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#change the location of the output folder </span></span>
<span><span class="va">projectConfiguration</span><span class="op">$</span><span class="va">outputFolder</span> <span class="op">&lt;-</span> <span class="st">"../anotherOutputFolder"</span></span>
<span></span>
<span><span class="co">#change the location of the model parameters file</span></span>
<span><span class="va">projectConfiguration</span><span class="op">$</span><span class="va">modelParametersFile</span> <span class="op">&lt;-</span> <span class="st">"../anotherModelParameters.xlsx"</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="add-new-scenario">Add new scenario<a class="anchor" aria-label="anchor" href="#add-new-scenario"></a>
</h4>
<ol style="list-style-type: decimal">
<li><p>After the model has been developed in PK-Sim and/or MoBi, a
simulation must be stored as a <em>.pkml</em> file in the
<code>Models/Simulations</code> folder.</p></li>
<li><p>To set up a simulation/scenario in <code>R</code>, open the file
<code>Scenarios.xlsx</code> located in the folder
<code>Parameters</code>. Start defining a scenario by giving it a
<em>name</em> in the <code>Scenario_name</code> column. Scenario name
will be used later to retrieve simulation results and use them e.g. in
figure definitions.</p></li>
<li><p>Specify the simulation <code>*.pkml</code> file to use in the
column <code>ModelFile</code>.</p></li>
</ol>
<p>If you simply want to run the simulation with the settings as it has
been exported from PK-Sim or MoBi, you can proceed to <a href="#running-scenarios">running Scenarios</a> section.</p>
</div>
<div class="section level4">
<h4 id="customize-the-scenario">Customize the scenario<a class="anchor" aria-label="anchor" href="#customize-the-scenario"></a>
</h4>
<div class="section level5">
<h5 id="simulation-parameters">4. Simulation Parameters<a class="anchor" aria-label="anchor" href="#simulation-parameters"></a>
</h5>
<p>You can define simulation parameters in the
<code>ModelParameters.xlsx</code> file. In order to apply to the
simulation, you need to specify which sheets to load in the
<code>ModelParameterSheets</code> column of the
<code>Scenarios.xlsx</code> file.</p>
</div>
<div class="section level5">
<h5 id="individuals">5. Individuals<a class="anchor" aria-label="anchor" href="#individuals"></a>
</h5>
<p>If you want to simulate a specific individual with individual
characteristics (age, weight, etc.) or apply individual model parameter
values to the simulation, define the individual in the
<code>IndividualId</code> column. Then create a new individual entry in
the <code>Individuals.xlsx</code> file.</p>
<ol style="list-style-type: lower-alpha">
<li>To create a new individual with specific biometrics, create a new
row in the <code>IndividualBiometrics</code> sheet.</li>
<li>To define an individual-specific parametrization, create a new sheet
and name it as the ID of the individual.</li>
</ol>
</div>
<div class="section level5">
<h5 id="population">6. Population<a class="anchor" aria-label="anchor" href="#population"></a>
</h5>
<p>If you want to run a <em>population simulation</em>, specify a
population in the column <code>PopulationId</code>. If you want to
create a new population each time you run the scenario, define
population demographics in the <code>Demographics</code> sheet of the
<code>PopulationParameters.xlsx</code> file. Keep in mind that
simulation results might differ each time you run the scenario, as new
population will be generated each time!</p>
<p>If you want to import a population from existing csv file, set the
value of the <code>ReadPopulationFromCSV</code> column to
<code>TRUE</code>. The population csv file must be located in the
<code>Parameters/Populations</code> folder.</p>
</div>
<div class="section level5">
<h5 id="time">7. Time<a class="anchor" aria-label="anchor" href="#time"></a>
</h5>
<p>Simulation time can also be changed with the
<code>SimulationTime</code> and <code>SimulationTimeUnit</code>
columns.</p>
</div>
<div class="section level5">
<h5 id="outputpath">8. OutputPath<a class="anchor" aria-label="anchor" href="#outputpath"></a>
</h5>
<p>You can define the outputs of the simulation in the
<code>OutputPathsIds</code> column. For convenience, not the full paths
to the outputs must be listed, but the their acronyms. The full path for
each acronym must be defined in the sheet <code>OutputPaths</code>.</p>
</div>
<div class="section level5">
<h5 id="administration-protocols">9. Administration Protocols<a class="anchor" aria-label="anchor" href="#administration-protocols"></a>
</h5>
<p>Finally, you can simulate different administration protocols from the
same simulation file by defining an application protocol in the column
<code>ApplicationProtocol</code>. See description below.</p>
</div>
</div>
</div>
<div class="section level3">
<h3 id="files-structure">Configuration files structure<a class="anchor" aria-label="anchor" href="#files-structure"></a>
</h3>
<p>The relevant excel files for definition of the scenarios are: -
<code>ApplicationParameters.xlsx</code> - <code>Individuals.xlsx</code>
- <code>ModelParameters.xlsx</code> -
<code>PopulationParameters.xlsx</code> - <code>Scenarios.xlsx</code></p>
<p>The <code>Scenarios</code> sheet of the <code>Scenarios.xlsx</code>
file has the following structure:</p>
<ul>
<li><p><strong>Scenario_name</strong><br>
unique name of the scenario. The name must be a <a href="https://cran.r-project.org/doc/FAQ/R-FAQ.html#What-are-valid-names_003f" class="external-link">valid
R variables name</a>.</p></li>
<li><p><strong>IndividualId</strong><br>
Name (ID) of an individual. This name refers to the name of the
individual as used in excel file <code>Individuals.xlsx</code> for
definition of the biometric properties (sheet
<code>IndividualBiometrics</code>) of the simulated individual
individual-specific model parameters. For the latter, create a separate
sheet in the <code>Individuals.xlsx</code> files with sheet name being
the <code>IndividualId</code>. The structure of these sheets is the same
as the structure of the sheets in <code>ModelParameter.xlsx</code> file,
see decription below.</p></li>
</ul>
<p><strong>IndividualId</strong> may be empty. In this case, the
individual as defined in the <code>pkml</code> simulation without any
individual-specific model parameters will be simulated.The same
individual can be used in multiple scenarios.</p>
<p>It is possible to scale from a human model to the species
<strong>Rat</strong>, <strong>Rabbit</strong>, and
<strong>Monkey</strong> by applying the respective individual to the
simulation. Other species scalings are technically possible but the
correctness of the results is not guaranteed as there exist some
structural differences between the species.</p>
<ul>
<li>
<strong>PopulationId</strong> Name (ID) of a population. If empty,
the scenario is simulated as an individual simulation. Otherwise,
population simulation is performed. If the column
<strong>ReadPopulationFromCSV</strong> is set to <code>FALSE</code>,
<strong>PopulationId</strong> refers to the name o f the population as
defined in the sheet <code>Demographics</code> of the file
<code>PopulationParameters.xlsx</code>. To create a population with
specific demographic characteristics, define an entry with the same
population id in the <code>Demographics</code>. The same population can
be used in multiple scenarios. If the column
<strong>ReadPopulationFromCSV</strong> is s et to <code>TRUE</code>, the
population will be imported from the csv file located in the folder
<code>Parameters/Populations</code>, the name of the file must be the id
of the population.</li>
</ul>
<p><strong>Note</strong>: You can define both an
<strong>IndividualId</strong> and a <strong>PopulationId</strong>. In t
his case, individual-specific parameters from the
<code>IndividualParameters.xlsx</code> will be applied to the simulation
prior to applying the population parameters. Keep in mind, that any
physiological parameters defined for an individual that are also part of
the parameter set of a population will be overwritten by the population!
If e.g. you specify the GFR of the individual in the
<code>IndividualParameters.xlsx</code>, it will be overwritten by the
GFR values sampled in the simulation.</p>
<ul>
<li><p><strong>ModelParameterSheets</strong> A list of sheet names from
the <code>ModelParameter.xlsx</code> file, separated by a
<code>,</code>. Each sheet must have the columns
<code>Container Path</code>, <code>Parameter Name</code>,
<code>Value</code>, and <code>Units</code>. Parameter values from
specified sheets will be applied to the model in the order of their
definition. E.g., if we define <code>Global, Aciclovir</code>, then
parameters from the <code>Aciclovir</code> sheet will be applied after
the <code>Global</code> parameters.
<strong>ModelParameterSheets</strong> may be empty or specify as many
sheets as required. Note that the specified sheets must be present in
the <code>ModelParameter.xlsx</code> file. The purpose of this approach
is to have <em>global</em> parameters that can be applied to most
scenarios, and separate set of parameters for e.g. different <em>disease
states</em> (parameter sheets <code>Healthy</code> and
<code>CKD</code>), or separate parametrization of different
<em>compounds</em> (sheet <code>Aciclovir</code>).<br>
You can further refine the parametrization of the scenario by specifying
the individual parameters in the <code>IndividualParameters.xlsx</code>
file. Create a sheet with the name as the <em>IndividualId</em>
specified for the respective scenario with the same structure as the
<code>ModelParameters.xlsx</code> file. This way you can define
e.g. individual-specific clearance values or, as in the example case,
the glomerular filtration rate. Individual specific parameters are
applied after the parameters defined in the
<em>ModelParameterSheets</em>. You can use an individual in multiple
scenarios. If an individual is specified in the scenario definition, but
no sheet with this name exists in the
<code>IndividualParameters.xlsx</code> file, this step is simply
ignored.</p></li>
<li><p><strong>ApplicationProtocol</strong> Name of the application
protocol that will be applied. Applications are defined as a set of
parameters that will be applied to the model in the file
<code>ApplicationParameters.xlsx</code>. For each application, create a
sheet with the name as specified in the
<strong>ApplicationProtocol</strong> entry and populate it with the same
structure as the <code>ModelParameter.xlsx</code> file. Configuring
application protocols this way requires that the loaded simulation
includes all possible applications that can be turned on and off by
setting parameters, e.g. the <code>Dose</code> or
<code>Start time</code> parameters. As it might be cumbersome to
manually create entries for all administration parameters, we can use
the <code><a href="../reference/getAllApplicationParameters.html">getAllApplicationParameters()</a></code> function to get a list of
all (constant) parameters located in the <code>Applications</code>
container. In the following example, we will extract application
parameters for the molecule <code>Aciclovir</code> from the example
simulation:</p></li>
</ul>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim</span> <span class="op">&lt;-</span> <span class="fu">loadSimulation</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"Aciclovir.pkml"</span>, package <span class="op">=</span> <span class="st">"ospsuite"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">applicationParams</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/getAllApplicationParameters.html">getAllApplicationParameters</a></span><span class="op">(</span><span class="va">sim</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">applicationParams</span><span class="op">)</span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt; Parameter: </span></span>
<span><span class="co">#&gt;    Path: Applications|IV 250mg 10min|Application_1|ProtocolSchemaItem|Start time </span></span>
<span><span class="co">#&gt;    Value: 0.00 [min] </span></span>
<span><span class="co">#&gt;    isConstant: TRUE </span></span>
<span><span class="co">#&gt;    isStateVariable: FALSE </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[2]]</span></span>
<span><span class="co">#&gt; Parameter: </span></span>
<span><span class="co">#&gt;    Path: Applications|IV 250mg 10min|Application_1|ProtocolSchemaItem|Dose </span></span>
<span><span class="co">#&gt;    Value: 0.00 [kg] </span></span>
<span><span class="co">#&gt;    isConstant: TRUE </span></span>
<span><span class="co">#&gt;    isStateVariable: FALSE </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[3]]</span></span>
<span><span class="co">#&gt; Parameter: </span></span>
<span><span class="co">#&gt;    Path: Applications|IV 250mg 10min|Application_1|ProtocolSchemaItem|DosePerBodySurfaceArea </span></span>
<span><span class="co">#&gt;    Value: 0.00 [kg/dm²] </span></span>
<span><span class="co">#&gt;    isConstant: TRUE </span></span>
<span><span class="co">#&gt;    isStateVariable: FALSE </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[4]]</span></span>
<span><span class="co">#&gt; Parameter: </span></span>
<span><span class="co">#&gt;    Path: Applications|IV 250mg 10min|Application_1|ProtocolSchemaItem|DosePerBodyWeight </span></span>
<span><span class="co">#&gt;    Value: 0.00 [kg/kg] </span></span>
<span><span class="co">#&gt;    isConstant: TRUE </span></span>
<span><span class="co">#&gt;    isStateVariable: FALSE </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[5]]</span></span>
<span><span class="co">#&gt; Parameter: </span></span>
<span><span class="co">#&gt;    Path: Applications|IV 250mg 10min|Application_1|ProtocolSchemaItem|Infusion time </span></span>
<span><span class="co">#&gt;    Value: 10.00 [min] </span></span>
<span><span class="co">#&gt;    isConstant: TRUE </span></span>
<span><span class="co">#&gt;    isStateVariable: FALSE</span></span></code></pre></div>
<p>and export the parameters to an excel file using the
<code><a href="../reference/exportParametersToXLS.html">exportParametersToXLS()</a></code> function:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/exportParametersToXLS.html">exportParametersToXLS</a></span><span class="op">(</span>parameters <span class="op">=</span> <span class="va">applicationParams</span>, paramsXLSpath <span class="op">=</span> <span class="st">"../Applications.xlsx"</span><span class="op">)</span></span></code></pre></div>
<p>The created excel file will have the same structure as all
Parameter-files and can be directly loaded in MoBi or R using the
<code><a href="../reference/readParametersFromXLS.html">readParametersFromXLS()</a></code> function.</p>
<ul>
<li><p><strong>SimulationTime</strong>: Time of the simulation. The <a href="https://www.open-systems-pharmacology.org/OSPSuite-R/reference/setOutputInterval.html" class="external-link">output
interval</a> of the simulation will be set to the range [0 -
<code>SimulationTime</code>] with the resolution of 1 point per
minute.</p></li>
<li><p><strong>SimulationTimeUnit</strong>: Unit for
<code>SimulationTime</code>. For supported units, see
<code><a href="https://www.open-systems-pharmacology.org/OSPSuite-R/reference/ospUnits.html" class="external-link">ospsuite::ospUnits</a></code>.</p></li>
<li><p><strong>SteadyState</strong>: If <code>TRUE</code>, the model
will be simulated for a “sufficiently long” time (1000 minutes by
default).</p></li>
<li><p><strong>SteadyStateTime</strong>: Time for the
steady-state.</p></li>
<li><p><strong>SteadyStateTimeUnit</strong>: Unit for
<code>SteadyStateTime</code>. For supported units, see
<code><a href="https://www.open-systems-pharmacology.org/OSPSuite-R/reference/ospUnits.html" class="external-link">ospsuite::ospUnits</a></code>.</p></li>
<li><p><strong>ModelFile</strong>: Name of the <code>pkml</code> file
with the simulation. Must be located in the folder defined in
<code>ProjectConfiguration$modelFolder</code>.</p></li>
<li>
<p><strong>OutputPathsIds</strong>: Paths of model outputs (i.e.,
paths to the molecules/ parameters for which outputs will be simulated)
can be defined in the sheet <code>OutputPaths</code>. Create an entry
for each output path by entering the full path into the column
<code>OutputPath</code> and defining a unique identifier to this path in
the column <code>OutputPathId</code>. The content of the sheet could
look like this:</p>
<table class="table">
<colgroup>
<col width="32%">
<col width="67%">
</colgroup>
<thead><tr class="header">
<th>OutputPathId</th>
<th>OutputPath</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Aciclovir_PVB</td>
<td>Organism|PeripheralVenousBlood|Aciclovir|Plasma (Peripheral Venous
Blood)</td>
</tr>
<tr class="even">
<td>Aciclovir_fat_cell</td>
<td>Organism|Fat|Intracellular|Aciclovir|Concentration in container</td>
</tr>
</tbody>
</table>
</li>
</ul>
<p>In the <code>Scenarios</code> sheet, enter the IDs of all paths the
outputs should be generated for, separated by a comma, e.g.
<code>Aciclovir_PVB, Aciclovir_fat_cell</code>.</p>
</div>
<div class="section level3">
<h3 id="code-based-specifications">Code-based specifications<a class="anchor" aria-label="anchor" href="#code-based-specifications"></a>
</h3>
<p>In addition to scenario setups through the excel sheets, further
specifications are made in the <code>R</code> files located in the
<code>InputCode</code> project folder. Files in this folder must be
sourced prior to using.</p>
<ul>
<li>
<strong>TestParameters</strong>: During model development/fitting
phase, you might want to test out parameter values before storing them
in the <code>Parameters</code> excel files. You can define the paths of
the parameters, their values and the units in the
<code>TestParameters</code> file. Remember to <code>source</code> the
file each time you change any values. You can turn setting test
parameters on and off in the <code>ScenarioConfiguration</code> (see
Section <a href="#running-scenarios">Running scenarios</a>).</li>
</ul>
</div>
<div class="section level3">
<h3 id="custom-functions">Custom functions<a class="anchor" aria-label="anchor" href="#custom-functions"></a>
</h3>
<p>Initialization of a scenario creates a <code>Simulation</code> object
that is fully parametrized according to the specifications of the
scenario. However, sometimes further modifications to the simulations
are required that cannot be represented by fixed parameter values stored
in excel files. Imagine a scenario where the value of a certain
parameter depends on other parameters not known at the time point of
excel file creation. Another use case is a dose escalation study.
Instead of defining every dose in a separate **ApplicationProtocol”
sheet, the set of doses to simulate could be defined in an
<code>R</code> list and passed as an argument to a function that sets
the dose parameter for a scenario.</p>
<p>This can be achieved through defining a function that will be applied
to the <code>Simulation</code> object created from a
<code>ScenarioConfiguration</code> at the very last step of
initialization. The function can reference the <code>simulation</code>
variable and accept additional arguments. The argument values are then
defined in the field <code>customFunctionArgs</code>.</p>
<p>In the following example, we will define a custom function that
multiplies the <code>Dose</code> parameter by a certain factor. The path
to the dose parameter and the multiplication factor are defined as
arguments.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create `ScenarioConfiguration` objects from excel files</span></span>
<span><span class="va">scenarioConfigurations</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/readScenarioConfigurationFromExcel.html">readScenarioConfigurationFromExcel</a></span><span class="op">(</span></span>
<span>  scenarioNames <span class="op">=</span> <span class="st">"TestScenario"</span>,</span>
<span>  projectConfiguration <span class="op">=</span> <span class="va">projectConfiguration</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Path to the dose parameter</span></span>
<span><span class="va">doseParamPath</span> <span class="op">&lt;-</span> <span class="st">"Applications|IV 250mg 10min|Application_1|ProtocolSchemaItem|Dose"</span></span>
<span></span>
<span><span class="co"># Initialize the simulation from the scenario without a custom function</span></span>
<span><span class="va">sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/initializeScenario.html">initializeScenario</a></span><span class="op">(</span><span class="va">scenarioConfigurations</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co"># get the value of dose parameter</span></span>
<span><span class="va">oldVal</span> <span class="op">&lt;-</span> <span class="fu">getQuantityValuesByPath</span><span class="op">(</span><span class="va">doseParamPath</span>, <span class="va">sim</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Default dose parameter value: "</span>, <span class="va">oldVal</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Default dose parameter value: 0.00025"</span></span>
<span></span>
<span><span class="co"># Define a custom function</span></span>
<span><span class="va">customFunction</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">doseFactor</span>, <span class="va">doseParamPath</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">doseParam</span> <span class="op">&lt;-</span> <span class="fu">getParameter</span><span class="op">(</span></span>
<span>    path <span class="op">=</span> <span class="va">doseParamPath</span>,</span>
<span>    container <span class="op">=</span> <span class="va">simulation</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">doseParam</span><span class="op">$</span><span class="va">value</span> <span class="op">&lt;-</span> <span class="va">doseParam</span><span class="op">$</span><span class="va">value</span> <span class="op">*</span> <span class="va">doseFactor</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Add the custom function to the scenario</span></span>
<span></span>
<span><span class="va">scenarioConfigurations</span><span class="op">$</span><span class="va">TestScenario</span><span class="op">$</span><span class="va">customFunction</span> <span class="op">&lt;-</span> <span class="va">customFunction</span></span>
<span></span>
<span><span class="co"># Set the values of the arguments</span></span>
<span><span class="va">scenarioConfigurations</span><span class="op">$</span><span class="va">TestScenario</span><span class="op">$</span><span class="va">customFunctionArgs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  doseFactor <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  doseParamPath <span class="op">=</span> <span class="va">doseParamPath</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Initialize the simulation with the scenario with the custom function and get</span></span>
<span><span class="co"># the value of the dose parameter.</span></span>
<span><span class="va">sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/initializeScenario.html">initializeScenario</a></span><span class="op">(</span><span class="va">scenarioConfigurations</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Dose parameter value with custom function: "</span>, <span class="fu">getQuantityValuesByPath</span><span class="op">(</span><span class="va">doseParamPath</span>, <span class="va">sim</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Dose parameter value with custom function: 5e-04"</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="scenario-parametrization-hierarchy">Scenario parametrization hierarchy<a class="anchor" aria-label="anchor" href="#scenario-parametrization-hierarchy"></a>
</h3>
<p>The final parametrization is a combination of the different
parametrization steps defined at various levels, as has been described
in the section above. The following figure summarizes the hierarchy of
the parametrization.</p>
<div class="figure">
<img src="Figures/ParametrizationHierarchy.png" alt=""><p class="caption">Parametrization sequence</p>
</div>
<p>If a parameter path is defined in multiple steps, its value will be
overwritten by the subsequent steps. That means, individual parameter
values will overwrite the values defined in the “ModelParameters.xlsx”
file, and parameters defined in <code>customParams</code> argument of
the <code><a href="../reference/runScenarios.html">runScenarios()</a></code> function will overwrite everything
else.</p>
<p>The order of parameter sheets of the “ModelParameters.xlsx” file
defined in the <strong>ModelParameterSheets</strong> column define the
order how the parameters are applied.</p>
</div>
<div class="section level3">
<h3 id="running-scenarios">Running scenarios<a class="anchor" aria-label="anchor" href="#running-scenarios"></a>
</h3>
<p>Scenarios are executed by creating <code>ScenarioConfiguration</code>
objects and calling the <code><a href="../reference/runScenarios.html">runScenarios()</a></code>function. Though it
is possible to create an empty <code>ScenarioConfiguration</code> and
populate it by hand, we usually want to create scenario configurations
from the excel files by calling the
<code><a href="../reference/readScenarioConfigurationFromExcel.html">readScenarioConfigurationFromExcel()</a></code> function. A
<code>ScenarioConfiguration</code> is based on the
<code>ProjectConfiguration</code>, which has to be provided as an
argument to the function. To read the configuration for the
<em>‘TestScenario’</em> scenario defined in the
<code>Scenarios.xlsx</code> file, we call</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create `ScenarioConfiguration` objects from excel files</span></span>
<span><span class="va">scenarioConfigurations</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/readScenarioConfigurationFromExcel.html">readScenarioConfigurationFromExcel</a></span><span class="op">(</span></span>
<span>  scenarioNames <span class="op">=</span> <span class="st">"TestScenario"</span>,</span>
<span>  projectConfiguration <span class="op">=</span> <span class="va">projectConfiguration</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">scenarioConfigurations</span><span class="op">$</span><span class="va">TestScenario</span><span class="op">)</span></span>
<span><span class="co">#&gt; ProjectConfiguration: </span></span>
<span><span class="co">#&gt;    Model folder: ../Models/Simulations </span></span>
<span><span class="co">#&gt;    Parameters folder: ../Parameters </span></span>
<span><span class="co">#&gt;    Parameters file name: ModelParameters.xlsx </span></span>
<span><span class="co">#&gt;    Individual parameters file name: Individuals.xlsx </span></span>
<span><span class="co">#&gt;    Population parameters file name: PopulationParameters.xlsx </span></span>
<span><span class="co">#&gt;    Scenario definitions file name: Scenarios.xlsx </span></span>
<span><span class="co">#&gt;    Scenario applications definitions file name: ApplicationParameters.xlsx </span></span>
<span><span class="co">#&gt;    Plot definitions file name: Plots.xlsx </span></span>
<span><span class="co">#&gt;    Experimental data folder: ../Data </span></span>
<span><span class="co">#&gt;    Experimental data file: TestProject_TimeValuesData.xlsx </span></span>
<span><span class="co">#&gt;    Data importer configuration: esqlabs_dataImporter_configuration.xml </span></span>
<span><span class="co">#&gt;    Output folder: ../Results </span></span>
<span><span class="co">#&gt; ScenarioConfiguration: </span></span>
<span><span class="co">#&gt;    Model file name: Aciclovir.pkml </span></span>
<span><span class="co">#&gt;    Scenario name: TestScenario </span></span>
<span><span class="co">#&gt;    Parameters sheets: Global </span></span>
<span><span class="co">#&gt;    Individual Id: Indiv1 </span></span>
<span><span class="co">#&gt;    Population Id: </span></span>
<span><span class="co">#&gt;    Read population from csv file: FALSE </span></span>
<span><span class="co">#&gt;    Application protocol: Aciclovir_iv_250mg </span></span>
<span><span class="co">#&gt;    Simulation time: 1440 </span></span>
<span><span class="co">#&gt;    Points per minute: 1 </span></span>
<span><span class="co">#&gt;    Simulate steady-state: FALSE </span></span>
<span><span class="co">#&gt;    Steady-state time: 1000 </span></span>
<span><span class="co">#&gt;    Set test parameters: FALSE</span></span></code></pre></div>
<p>Alternatively, we can create configurations for all scenarios defined
in the <code>Scenarios.xlsx</code> by calling
<code>readScenarioConfigurationFromExcel(projectConfiguration = projectConfiguration)</code>
without specifying scenarios’ names.</p>
<p>Before running the scenarios, we can modify
<code>ScenarioConfigurations</code> by setting parameters that are
currently not accessible through excel files. In model
development/fitting phase, we might want to apply some test parameter
values:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Set output paths for each scenario</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">scenarioConfiguration</span> <span class="kw">in</span> <span class="va">scenarioConfigurations</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">scenarioConfiguration</span><span class="op">$</span><span class="va">setTestParameters</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Make sure that you have sourced the <code>TestParameters</code> file
in this case.</p>
<p>Once all scenario configurations are set up, we can simulate them by
calling the <code><a href="../reference/runScenarios.html">runScenarios()</a></code> function. We can specify to save
the initialized simulation (i.e. the simulation with individual
physiology and parametrization applied as defined by the scenario
configuration). In such case, a folder with the current date and time
will be created in the folder where the simulation <code>pkml</code>
files are located.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simulatedScenarios</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/runScenarios.html">runScenarios</a></span><span class="op">(</span></span>
<span>  scenarioConfigurations <span class="op">=</span> <span class="va">scenarioConfigurations</span>,</span>
<span>  customParams <span class="op">=</span> <span class="cn">NULL</span>, saveSimulationsToPKML <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">simulatedScenarios</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "TestScenario"</span></span></code></pre></div>
<p>It is a good idea to store simulation results as <code>*.csv</code>
along with simulations as <code>.*pkml</code> and, optionally, the used
population as <code>*.scv</code> file and load them for further
processing to avoid re-simulating every time e.g. a change to a figure
showing the simulation results is required. The convenient function for
saving results of a scenario run is
<code><a href="../reference/saveScenarioResults.html">saveScenarioResults()</a></code>.</p>
<p>For futher information, check out the documentation of the functions
<a href="https://esqlabs.github.io/esqlabsR/reference/saveScenarioResults"><code>saveScenarioResults()</code></a>
and <a href="https://esqlabs.github.io/esqlabsR/reference/loadScenarioResults"><code>loadScenarioResults()</code></a>.</p>
<p>The function returns results of the simulations. For each scenario, a
<a href="https://www.open-systems-pharmacology.org/OSPSuite-R/reference/Simulation.html" class="external-link"><code>Simulation</code></a>
object, a <a href="https://www.open-systems-pharmacology.org/OSPSuite-R/reference/SimulationResults.html" class="external-link"><code>SimulationResults</code></a>
object, and vectors of output values (retrieved by the <a href="https://www.open-systems-pharmacology.org/OSPSuite-R/reference/getOutputValues.html" class="external-link"><code>getOutputValues()</code></a>
function) are returned.</p>
</div>
<div class="section level3">
<h3 id="troubleshooting">Troubleshooting<a class="anchor" aria-label="anchor" href="#troubleshooting"></a>
</h3>
<p>More detailed information on function signatures can be found in:</p>
<ul>
<li>
<code>esqlabsR</code> documentation on:
<ul>
<li><a href="https://esqlabs.github.io/esqlabsR/reference/ProjectConfiguration.html">ProjectConfiguration
class</a></li>
<li><a href="https://esqlabs.github.io/esqlabsR/reference/ScenarioConfiguration.html">ScenarioConfiguration
class</a></li>
<li><a href="https://esqlabs.github.io/esqlabsR/reference/readScenarioConfigurationFromExcel.html">readScenarioConfigurationFromExcel()</a></li>
<li><a href="https://esqlabs.github.io/esqlabsR/reference/runScenarios.html">runScenarios()</a></li>
</ul>
</li>
</ul>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by <a href="https://esqlabs.com/" class="external-link"><img src="https://esqlabs.github.io/esqlabsR/reference/figures/esqlabs.png" height="24"></a>, Pavel Balazki, Johanna Eitel, <a href="https://sites.google.com/site/indrajeetspatilmorality/" class="external-link">Indrajeet Patil</a>, Sergei Vavilov.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
